<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Descargar Planos Terranova</title>

  <!-- Librerías necesarias -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: row;
      height: 100vh;
      margin: 0;
      background: #f9fafb;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      gap: 15px;
    }

    button {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    button:hover {
      transform: translateY(-2px);
    }

    #btnComercial {
      background-color: #007bff;
    }

    #btnComercial:hover {
      background-color: #0056b3;
    }

    #btnMensura {
      background-color: #28a745;
    }

    #btnMensura:hover {
      background-color: #1e7e34;
    }

    /* Responsivo pero sin romper el formato horizontal */
    @media (max-width: 600px) {
      body {
        flex-wrap: wrap;
        padding: 20px;
        gap: 10px;
      }

      button {
        flex: 1 1 auto;
        min-width: 140px;
        font-size: 15px;
        padding: 12px 20px;
      }
    }

    /* Mapa oculto (no visible en la interfaz) */
    #map {
      position: fixed;
      top: -9999px;
      left: -9999px;
      width: 2000px;
      height: 2828px;
      visibility: hidden;
      z-index: -1;
    }
  </style>
</head>

<body>
  <button id="btnComercial">Descargar Plano Comercial</button>
  <button id="btnMensura">Descargar Plano con Mensura</button>

  <!-- Mapa invisible -->
  <div id="map"></div>

<script>
  // Configuración del mapa invisible
  const originalWidth = 2000;  // tu ancho real del plano
  const originalHeight = 2828; // tu alto real del plano
  const bounds = [[0, 0], [originalHeight, originalWidth]];

  const map = L.map("map", {
    crs: L.CRS.Simple,
    zoomSnap: 0.5,
    zoomControl: false,
    attributionControl: false,
  });

  L.imageOverlay(
    "https://sarif-arg.github.io/actualizador-de-precios/plano_terranova_base.svg",
    bounds
  ).addTo(map);

  map.fitBounds(bounds);

  // Cargar y agregar GeoJSON con color de lotes
  fetch("https://sarif-arg.github.io/actualizador-de-precios/terranova.geojson")
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        style: {
          color: "#ffffff",
          weight: 0.8,
          fillOpacity: 0.85,
        },
      }).addTo(map);
    });

  // Espera a que todo esté renderizado antes de permitir descarga
  let mapaListo = false;
  map.whenReady(() => {
    setTimeout(() => { mapaListo = true; }, 5000); // pequeña espera de seguridad
  });

  // Descargar plano comercial
  document.getElementById("btnComercial").addEventListener("click", async () => {
    if (!mapaListo) {
      alert("Esperá un momento que el plano termine de cargar...");
      return;
    }

    const mapElement = document.getElementById("map");
    const canvas = await html2canvas(mapElement, {
      useCORS: true,
      scale: 1.2, // suficiente calidad, sin gigantismo
      backgroundColor: null, // mantiene fondo transparente
    });

    const imgData = canvas.toDataURL("image/jpeg", 0.92);
    const pdf = new jspdf.jsPDF({
      orientation: "portrait",
      unit: "px",
      format: [originalWidth, originalHeight],
    });

    pdf.addImage(imgData, "JPEG", 0, 0, originalWidth, originalHeight);

    // Footer con fecha y título
    const fecha = new Date().toLocaleDateString("es-AR", { year: "numeric", month: "long", day: "numeric" });
    pdf.setFontSize(18);
    pdf.text("Terranova – Plano Comercial", 40, 40);
    pdf.setFontSize(12);
    pdf.text(`Generado el ${fecha}`, 40, 65);

    pdf.save("plano_terranova_comercial.pdf");
  });

  // Descargar plano con mensura (PDF estático)
  document.getElementById("btnMensura").addEventListener("click", () => {
    window.open("https://sarif-arg.github.io/plano_terranova_mensura.pdf", "_blank");
  });
</script>
</body>
</html>
